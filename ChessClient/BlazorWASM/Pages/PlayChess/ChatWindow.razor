@using Application.LogicInterfaces
@using Domain.DTOs.Chat
@using MudBlazor
@using Application.LogicImplementations
@using Rudzoft.ChessLib.Extensions
@inject IChatLogic ChatLogic
@implements IDisposable

<MudContainer Class="pa-0">
    <MudPaper Class="overflow-x-auto" Height="400px">@((MarkupString) _resultMsg)</MudPaper>
    <MudTextField Immediate="true" T="string" InputType="InputType.Text" placeholder="Enter message" @bind-Value="_messageBody" OnKeyPress="OnKeyPress"/>
    <MudButton OnClick="WriteMessageAsync" Color="Color.Secondary">Send</MudButton>
</MudContainer>


@code {
    private string _messageBody = "";

    [Parameter]
    public string Receiver { get; set; } = string.Empty;

    private string _resultMsg = "";


    protected override void OnInitialized()
    {
        ChatLogic.MessageReceived += OnMessageReceived;
    }

    public void Dispose()
    {
        ChatLogic.MessageReceived -= OnMessageReceived;
    }


    private async Task WriteMessageAsync()
    {
        if (Receiver.IsNullOrEmpty())
        {
            throw new InvalidOperationException("Player not connected");
        }
        if (IsValid())
        {
            await ChatLogic.WriteMessageAsync(new MessageDto
            {
                Body = _messageBody,
                Receiver = Receiver
            });
            _messageBody = "";
            StateHasChanged();
        }
    }

    private void OnMessageReceived(MessageDto dto)
    {
        _resultMsg += $"<div>{dto.Username}:{dto.Body}\n</div>";
        StateHasChanged();
    }

    private bool IsValid()
    {
        return !string.IsNullOrEmpty(_messageBody);
    }

    private async void OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Code is not ("Enter" or "NumpadEnter")) return;
        if (IsValid())
        {
            await WriteMessageAsync();
        }
    }

}