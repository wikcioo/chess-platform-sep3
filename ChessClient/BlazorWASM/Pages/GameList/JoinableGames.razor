@using MudBlazor
@using Domain.DTOs
@using Application.LogicInterfaces
@using Domain.DTOs.GameRoomData
@using Rudzoft.ChessLib
@inject IGameLogic GameLogic
@inject ISnackbar Snackbar
@inject NavigationManager NavMgr

<MudContainer Style="display: flex; justify-content: space-between">
    <MudButton @onclick="JoinRandomGame">Play Random</MudButton>
    <MudIconButton Icon="@Icons.Filled.Refresh" @onclick="RefreshJoinableGames"></MudIconButton>
</MudContainer>
<MudTable Items="@_joinableGames" Hover="true">
    <HeaderContent>
        <MudTh>Game Id</MudTh>
        <MudTh>Opponent</MudTh>
        <MudTh>Time Control</MudTh>
        <MudTh>Side</MudTh>
        <MudTh>Join Game</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Id">@context.GameRoom</MudTd>
        <MudTd DataLabel="User">@context.Username</MudTd>
        <MudTd DataLabel="Time Control">@(context.Seconds + "+" + context.Increment)</MudTd>
        <MudTd DataLabel="Side">@context.Side</MudTd>
        <MudTd DataLabel="Join">
            <MudButton @onclick="() => JoinGame(context.GameRoom)">Join</MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager/>
    </PagerContent>
</MudTable>

@code {
    private IList<JoinableGameRoomDataDto>? _joinableGames;

    protected override async Task OnInitializedAsync()
    {
        await RefreshJoinableGames();
    }

    private async Task RefreshJoinableGames()
    {
        _joinableGames = await GameLogic.GetAllJoinableGames();
    }

    private void JoinGame(ulong i)
    {
        NavMgr.NavigateTo("/ChessGame");
        GameLogic.JoinGame(new RequestJoinGameDto
        {
            GameRoom = i
        });
    }

    private async void JoinRandomGame()
    {
        await RefreshJoinableGames();
        
        if (_joinableGames.Count > 0)
        {
            NavMgr.NavigateTo("/ChessGame");
            var randomGameRoomId = _joinableGames[new Random().Next(_joinableGames.Count)].GameRoom;
            GameLogic.JoinGame(new RequestJoinGameDto
            {
                GameRoom = randomGameRoomId
            });
        }
        else
        {
            Snackbar.Add("No active games to join!", Severity.Info, config =>
            {
                config.Action = "New Game";
                config.Onclick = _ =>
                {
                    NavMgr.NavigateTo("/StartGame");
                    return Task.CompletedTask;
                };
            });
        }
    }
}